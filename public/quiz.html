<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å®Ÿè·µå•é¡Œ - æ ªä¾¡äºˆæ¸¬ã‚¯ã‚¤ã‚º</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 800px;
        margin: 20px auto;
        padding: 0 20px;
      }
      #chart-container {
        position: relative;
        height: 40vh;
        width: 100%;
        margin-bottom: 20px;
      }
      #answer-buttons button {
        font-size: 1.2em;
        padding: 10px 20px;
        margin: 0 10px;
        cursor: pointer;
      }
      #result-area {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
      }
      .correct {
        background-color: #e0f7fa;
        border: 1px solid #00acc1;
      }
      .incorrect {
        background-color: #ffebee;
        border: 1px solid #f44336;
      }
      #next-question {
        display: none;
        margin-top: 15px;
        font-size: 1em;
        padding: 8px 15px;
        cursor: pointer;
      }
    </style>
    <!-- Chart.jsãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <h1>å®Ÿè·µå•é¡Œ - æ ªä¾¡äºˆæ¸¬ã‚¯ã‚¤ã‚º</h1>
    <p>
      ã“ã®ãƒãƒ£ãƒ¼ãƒˆã®æ¬¡ã®å€¤å‹•ãã¯ã©ã†ãªã‚‹ï¼Ÿã€Œä¸ŠãŒã‚‹ã€ã‹ã€Œä¸‹ãŒã‚‹ã€ã‹äºˆæƒ³ã—ã‚ˆã†ï¼
    </p>
    <h2 id="ticker-name">éŠ˜æŸ„å: èª­ã¿è¾¼ã¿ä¸­...</h2>

    <div id="chart-container">
      <canvas id="stockChart"></canvas>
    </div>

    <div id="answer-buttons">
      <button id="up-btn">ğŸ“ˆ ä¸ŠãŒã‚‹</button>
      <button id="down-btn">ğŸ“‰ ä¸‹ãŒã‚‹</button>
    </div>

    <div id="result-area"></div>
    <button id="next-question">æ¬¡ã®å•é¡Œã¸</button>

    <hr style="margin-top: 30px" />
    <a href="/">å­¦ç¿’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä¸€è¦§ã«æˆ»ã‚‹</a>

    <script>
      const tickerNameEl = document.getElementById("ticker-name");
      const upBtn = document.getElementById("up-btn");
      const downBtn = document.getElementById("down-btn");
      const resultArea = document.getElementById("result-area");
      const nextBtn = document.getElementById("next-question");
      const ctx = document.getElementById("stockChart").getContext("2d");
      let chart;
      let quizData;

      async function fetchQuiz() {
        try {
          const response = await fetch("/api/quiz-charts/random");
          quizData = await response.json();

          // chartDataãŒæ–‡å­—åˆ—ã®å ´åˆã€JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
          if (typeof quizData.chartData === "string") {
            quizData.chartData = JSON.parse(quizData.chartData);
          }

          tickerNameEl.textContent = `éŠ˜æŸ„å: ${quizData.tickerName}`;
          drawChart(quizData.chartData);
        } catch (error) {
          console.error(error);
          tickerNameEl.textContent = "ã‚¯ã‚¤ã‚ºã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        }
      }

      function drawChart(data) {
        if (chart) {
          chart.destroy();
        }
        chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: data.map((_, i) => i + 1), // Xè»¸ã®ãƒ©ãƒ™ãƒ« (1, 2, 3...)
            datasets: [
              {
                label: "æ ªä¾¡",
                data: data,
                borderColor: "rgba(75, 192, 192, 1)",
                tension: 0.1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { title: { display: true, text: "æœŸé–“" } } },
          },
        });
      }

      function handleAnswer(userAnswer) {
        upBtn.disabled = true;
        downBtn.disabled = true;

        const isCorrect = userAnswer === quizData.answer;

        resultArea.classList.add(isCorrect ? "correct" : "incorrect");
        resultArea.innerHTML = `
          <h3>${isCorrect ? "æ­£è§£ï¼" : "ä¸æ­£è§£..."}</h3>
          <p>æ­£è§£ã¯ã€Œ${
            quizData.answer === "up" ? "ä¸ŠãŒã‚‹" : "ä¸‹ãŒã‚‹"
          }ã€ã§ã—ãŸã€‚</p>
          <p><strong>è§£èª¬:</strong> ${quizData.explanation}</p>
        `;
        nextBtn.style.display = "block";
      }

      upBtn.addEventListener("click", () => handleAnswer("up"));
      downBtn.addEventListener("click", () => handleAnswer("down"));
      nextBtn.addEventListener("click", () => {
        window.location.reload(); // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æ¬¡ã®å•é¡Œã¸
      });

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚¯ã‚¤ã‚ºã‚’å–å¾—
      fetchQuiz();
    </script>
  </body>
</html>
