<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å®Ÿè·µå•é¡Œ - æ ªä¾¡äºˆæ¸¬ã‚¯ã‚¤ã‚º</title>
    <!-- CSSã¨Google Fontsã®ãƒªãƒ³ã‚¯ã‚’è¿½åŠ  -->
    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <!-- Chart.jsãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <header>
      <h1>å®Ÿè·µå•é¡Œ</h1>
    </header>

    <main class="container">
      <div class="quiz-container">
        <p>
          ã“ã®ãƒãƒ£ãƒ¼ãƒˆã®æ¬¡ã®å€¤å‹•ãã¯ã©ã†ãªã‚‹ï¼Ÿã€Œä¸ŠãŒã‚‹ã€ã‹ã€Œä¸‹ãŒã‚‹ã€ã‹äºˆæƒ³ã—ã‚ˆã†ï¼
        </p>
        <h2 id="ticker-name">éŠ˜æŸ„å: èª­ã¿è¾¼ã¿ä¸­...</h2>

        <div id="chart-container">
          <canvas id="stockChart"></canvas>
        </div>

        <div id="answer-buttons">
          <button id="up-btn">ğŸ“ˆ ä¸ŠãŒã‚‹</button>
          <button id="down-btn">ğŸ“‰ ä¸‹ãŒã‚‹</button>
        </div>

        <div id="result-area"></div>
        <button id="next-question">æ¬¡ã®å•é¡Œã¸</button>
      </div>
      <a href="/" class="back-link">â† å­¦ç¿’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä¸€è¦§ã«æˆ»ã‚‹</a>
    </main>

    <script>
      const tickerNameEl = document.getElementById("ticker-name");
      const upBtn = document.getElementById("up-btn");
      const downBtn = document.getElementById("down-btn");
      const resultArea = document.getElementById("result-area");
      const nextBtn = document.getElementById("next-question");
      const ctx = document.getElementById("stockChart").getContext("2d");
      let chart;
      let quizData;

      async function fetchQuiz() {
        try {
          const response = await fetch("/api/quiz-charts/random");
          quizData = await response.json();

          if (typeof quizData.chartData === "string") {
            quizData.chartData = JSON.parse(quizData.chartData);
          }

          tickerNameEl.textContent = `éŠ˜æŸ„å: ${quizData.tickerName}`;
          drawChart(quizData.chartData);
        } catch (error) {
          console.error(error);
          tickerNameEl.textContent = "ã‚¯ã‚¤ã‚ºã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        }
      }

      function drawChart(data) {
        if (chart) {
          chart.destroy();
        }
        chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: data.map((_, i) => i + 1),
            datasets: [
              {
                label: "æ ªä¾¡",
                data: data,
                borderColor: "rgba(0, 82, 155, 1)", // è‰²ã‚’ãƒ†ãƒ¼ãƒã«åˆã‚ã›ã‚‹
                backgroundColor: "rgba(0, 82, 155, 0.1)",
                fill: true,
                tension: 0.1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { title: { display: true, text: "æœŸé–“" } } },
          },
        });
      }

      function handleAnswer(userAnswer) {
        upBtn.disabled = true;
        downBtn.disabled = true;

        const isCorrect = userAnswer === quizData.answer;

        resultArea.classList.add(isCorrect ? "correct" : "incorrect");
        resultArea.innerHTML = `
          <h3>${isCorrect ? "æ­£è§£ï¼" : "ä¸æ­£è§£..."}</h3>
          <p>æ­£è§£ã¯ã€Œ${
            quizData.answer === "up" ? "ä¸ŠãŒã‚‹" : "ä¸‹ãŒã‚‹"
          }ã€ã§ã—ãŸã€‚</p>
          <p><strong>è§£èª¬:</strong> ${quizData.explanation}</p>
        `;
        nextBtn.style.display = "block";
      }

      upBtn.addEventListener("click", () => handleAnswer("up"));
      downBtn.addEventListener("click", () => handleAnswer("down"));
      nextBtn.addEventListener("click", () => {
        window.location.reload();
      });

      fetchQuiz();
    </script>
  </body>
</html>
